<html xmlns="http:www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <title>Create evidence</title>
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css" />
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

    <script type="text/javascript">
        var TableManager = function(tableId, rowTag) {
            var mgr = {};
            mgr.tableId = tableId;
            mgr.rowTag  = rowTag;

            mgr.appendRow = function(obj) {
                var table = $("#" + mgr.tableId);
                var newRow = table.find("#" + mgr.tableId + "_template").clone();
                mgr.wireUpRow(newRow);
                mgr.setRowData(newRow, obj);
                table.append(newRow);
            }

            mgr.appendEmptyRow = function() {
                mgr.appendRow({name: null, value: null});
            }

            mgr.prependRow = function(obj) {
                var table = $("#" + mgr.tableId);
                var newRow = table.find("#" + mgr.tableId + "_template").clone();
                mgr.wireUpRow(newRow);
                mgr.setRowData(newRow, obj);
                table.prepend(newRow);
            }

            mgr.wireUpRow = function(row) {
                row.find('button[name="' + mgr.rowTag + '_add"]').click(function() {
                    mgr.appendEmptyRow();
                });

                row.find('button[name="' + mgr.rowTag + '_delete"]').click(function(evt) {
                    var table = $("#" + mgr.tableId);
                    var numTableRows = table.find('tr[title="' + mgr.rowTag + '"]').size();
                    if (numTableRows > 1) {
                        $(evt.target).parents('tr').remove();
                    }
                });
            }

            mgr.getRows = function() {
                var table = $("#" + mgr.tableId);
                return table.
                    find('tr[title="' + mgr.rowTag + '"]').
                    map(function(index, element) {
                        return mgr.getRowData(element);
                    }).
                    get();
            }

            mgr.getRowData = function(row) {
                var input_name  = mgr.rowTag + "_name";
                var input_value = mgr.rowTag + "_value";
                return {
                    name:  $(row).find('input[name="' + input_name + '"]').val(),
                    value: $(row).find('input[name="' + input_value + '"]').val(),
                };
            }

            mgr.setRowData = function(row, obj) {
                Object.getOwnPropertyNames(obj).forEach(function(name, idx, array) {
                    row.find('input[name="' + mgr.rowTag + '_' + name + '"]').val(obj[name]);
                });
            }

            var table = $("#" + mgr.tableId);
            mgr.wireUpRow(table.find("#" + mgr.tableId + "_template"));

            return mgr;
        }

        function reset() {
            var form = document.getElementById("evidence-form");
            form.reset();
        }

        function readFormAsJSON() {
            var bel_statement = document.getElementById('bel-statement');
            var citation_type = document.getElementById('citation-type');
            var citation_id   = document.getElementById('citation-id');
            var citation_name = document.getElementById('citation-name');
            var summary_text  = document.getElementById('summary-text');

            var evidence = {
                bel_statement:      bel_statement.value,
                citation: {
                    type: citation_type.value,
                    id:   citation_id.value,
                    name: citation_name.value
                },
                summary_text:       summary_text.value,
                experiment_context: window.experimentContextTableManager.getRows().
                                        filter(function(item) {
                                            return item.name.trim() && item.value.trim();
                                        }).
                                        reduce(function(resultObject, item) {
                                            resultObject[item.name] = item.value;
                                            return resultObject;
                                        }, {}),
                metadata:           window.metadataTableManager.getRows().
                                        filter(function(item) {
                                            return item.name.trim() && item.value.trim();
                                        }).
                                        reduce(function(resultObject, item) {
                                            resultObject[item.name] = item.value;
                                            return resultObject;
                                        }, {})
            }

            return JSON.stringify(evidence);
        }

        function populateForm() {
            var evidenceJSON       = document.getElementById('evidence-json').childNodes[0].nodeValue;
            var evidence           = JSON.parse(evidenceJSON);

            var belStatement       = document.getElementById('bel-statement');
            belStatement.value     = evidence.bel_statement;

            var citationType       = document.getElementById('citation-type');
            citationType.value     = evidence.citation.type;

            var citationId         = document.getElementById('citation-id');
            citationId.value       = evidence.citation.id;

            var citationName       = document.getElementById('citation-name');
            citationName.value     = evidence.citation.name;

            var summaryText        = document.getElementById('summary-text');
            summaryText.value      = evidence.summary_text;

            var experimentContext = evidence.experiment_context;
            Object.getOwnPropertyNames(experimentContext).
                sort(function(str1, str2) {
                    return  (str1 || "").toLowerCase().localeCompare((str2 || "").toLowerCase());
                }).
                reverse().
                forEach(function(name, idx, array) {
                    window.experimentContextTableManager.prependRow({
                        name:  name.slice('experiment_context_'.length),
                        value: experimentContext[name]
                    });
                });

            var metadata = evidence.metadata;
            Object.getOwnPropertyNames(metadata).
                sort(function(str1, str2) {
                    return  (str1 || "").toLowerCase().localeCompare((str2 || "").toLowerCase());
                }).
                reverse().
                forEach(function(name, idx, array) {
                    window.metadataTableManager.prependRow({
                        name:  name.slice('metadata_'.length),
                        value: metadata[name]
                    });
                });
        }

        $(document).ready(function() {
            window.experimentContextTableManager = new TableManager('experiment_contexts', 'experiment_context');
            window.metadataTableManager          = new TableManager('metadatas',   'metadata');
        });
    </script>
</head>

<body>
<form id="evidence-form" class="form-horizontal">
    <fieldset>
        <fieldset>
            <legend>BEL Statement</legend>
            <div class="form-group">
                <label class="col-md-2 control-label" for="bel-statement"></label>
                <div class="col-md-8">
                    <input id="bel-statement" name="bel-statement" placeholder="Subject Relationship Object" class="form-control input-md" required="" type="text">
                    <span class="help-block">i.e. p(HGNC:AKT1) -> bp(MESHPP:Apoptosis)</span>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>Citation</legend>
            <div class="form-group">
                <label class="col-md-2 control-label" for="citation-type">Type</label>
                <div class="col-md-8">
                    <select id="citation-type" name="citation-type" class="form-control">
                        <option value="PubMed">PubMed</option>
                        <option value="Book">Book</option>
                        <option value="Journal">Journal</option>
                        <option value="Online Resource">Online Resource</option>
                        <option value="Other">Other</option>
                    </select>
                    <span class="help-block">Fixed set of citation types</span>
                </div>
            </div>

            <div class="form-group">
                <label class="col-md-2 control-label" for="citation-id">ID</label>
                <div class="col-md-8">
                    <input id="citation-id" name="citation-id" placeholder="Identifier" class="form-control input-md" required="" type="text">
                    <span class="help-block">i.e. 9202001</span>
                </div>
            </div>

            <div class="form-group">
                <label class="col-md-2 control-label" for="citation-name">Name</label>
                <div class="col-md-8">
                    <input id="citation-name" name="citation-name" placeholder="Name" class="form-control input-md" required="" type="text">
                    <span class="help-block">i.e. J Biol Chem. 1997 Jul 4;272(27):16917-23.</span>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>Summary Text</legend>
            <div class="form-group">
                <label class="col-md-2 control-label" for="summary-text"></label>
                <div class="col-md-6">
                    <textarea class="form-control" rows="5" id="summary-text" name="summary-text"></textarea>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>Experiment Context</legend>

            <div class="container">
                <div class="row clearfix">
                    <div class="col-md-18 column">
                        <table class="table table-bordered table-hover" id="experiment_contexts">
                            <col style="width:25%">
                            <col style="width:60%">
                            <col style="width:15%">
                            <thead>
                            <tr>
                                <th>
                                    Name
                                </th>
                                <th>
                                    Value
                                </th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr id="experiment_contexts_template" title="experiment_context">
                                <td>
                                    <input type="text" name="experiment_context_name" placeholder="Keyword (i.e. Disease, Cell, Tissue)" class="form-control" />
                                </td>
                                <td>
                                    <input type="text" name="experiment_context_value" placeholder="Value (i.e. Lung, Carcinoma)" class="form-control" />
                                </td>
                                <td>
                                    <button name="experiment_context_add" class="btn btn-success glyphicon glyphicon-plus row-add"></button>
                                    <button name="experiment_context_delete" class="btn btn-danger glyphicon glyphicon-remove row-remove"></button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </fieldset>

        <fieldset>
            <legend>Metadata</legend>

            <div class="container">
                <div class="row">
                    <div class="col-md-20 column">
                        <table class="table table-bordered table-hover" id="metadatas">
                            <col style="width:25%">
                            <col style="width:60%">
                            <col style="width:15%">
                            <thead>
                            <tr>
                                <th>
                                    Name
                                </th>
                                <th>
                                    Value
                                </th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr id="metadatas_template" title="metadata">
                                <td>
                                    <input type="text" name="metadata_name" placeholder="Name (i.e. Id, Date, Creator)" class="form-control" />
                                </td>
                                <td>
                                    <input type="text" name="metadata_value" placeholder="Value (i.e. 321321, 2015-07-14, dpncab)" class="form-control" />
                                </td>
                                <td>
                                    <button name="metadata_add" class="btn btn-success glyphicon glyphicon-plus row-add"></button>
                                    <button name="metadata_delete" class="btn btn-danger glyphicon glyphicon-remove row-remove"></button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </fieldset>

        <div class="form-group">
            <div class="col-md-8">
                <button id="save-button" name="save-button" class="btn btn-primary">Save</button>
                <button id="reset-button" name="reset-button" class="btn btn-warning">Reset</button>
            </div>
        </div>
    </fieldset>
</form>
</body>

</html>

<!-- vim: ft=html sw=4 ts=4 sts=4 expandtab -->
